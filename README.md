# Fantasy Map Generator (Work in Progress)

This program is an implementation of a fantasy map generator based on the methods described in Martin O'Leary's "Generating fantasy map" notes (https://mewo2.com/notes/terrain/).

# Progress

## Generating Irregular Grids

A Poisson Disc Sampler generates a set of random points with the property that no two points are within a set radius of eachother.
![alt tag](http://rlguy.com/map_generation/images/uniform_vs_poisson_sampling.jpg)

The set of points are triangulated in a Delaunay triangulation. The triangulation is stored in a doubly connected edge list (DCEL) data structure.
![alt tag](http://rlguy.com/map_generation/images/uniform_vs_poisson_delaunay.jpg)

The dual of the Delaunay triangulation is computed to produce a Voronoi diagram, which is also stored as a DCEL.
![alt tag](http://rlguy.com/map_generation/images/uniform_vs_poisson_voronoi.jpg)

Each vertex in the Delaunay triangulation becomes a face in the Voronoi diagram, and each triangle in the Delaunay triangulation becomes a vertex in the Voronoi diagram. A triangle is transformed into a vertex by fitting a circle to the three triangle vertices and setting the circle's center as the position of a Voronoi vertex. The following image displays the relationship between a Delaunay triangulation and a Voronoi diagram.

![alt tag](http://rlguy.com/map_generation/images/voronoi_delaunay_overlay.jpg)

The vertices in the Voronoi diagram will be used as the nodes in an irregular grid. Note that each node has exactly three neighbours.

## Generating Terrain

An initial height map is generated using a set of primitives:
- addHill - Create a rounded hill where height falls off smoothly
- addCone - Create a cone where height falls off linearly
- addSlope - Create a slope gradient that runs parallel to a line

and a set of operations:
- normalize - Normalize the height map values to [0,1]
- round - Round height map features by normalizing and taking the square root of the height values
- relax - Replace height values with the average of their neighbours
- setSeaLevel - Translate the height map so that the new sea level is at zero

![alt tag](http://rlguy.com/map_generation/images/heightmap_primitives.jpg)

Contour lines are generated from the Voronoi edges. If a contour line is generated for some elevation h, a Voronoi edge will be included in the countour if one of its adjacent faces has a height less than h while the other has a height greater than or equal to h.

![alt tag](http://rlguy.com/map_generation/images/heightmap_contour.jpg)

A flow map is generated by tracing the route that water would flow over the map. At each point on the grid, a path must be traced downhill to the edge of the map. This means that there can be no sinks or depressions within the height map. Depressions are filled by using the [Planchon-Darboux Algorithm](http://horizon.documentation.ird.fr/exl-doc/pleins_textes/pleins_textes_7/sous_copyright/010031925.pdf) to ensure that a path to the edge of the map exists for all grid points.

![alt tag](http://rlguy.com/map_generation/images/flowmap.jpg)

The height map is then eroded by using the flow map data and terrain slope data.

![alt tag](http://rlguy.com/map_generation/images/erosion_process.jpg)

Paths representing rivers are generated at points where the amount of flux (river current) is above some threshold. The path of the river follows the flow map until it reaches a coastline or the edge of the map.

![alt tag](http://rlguy.com/map_generation/images/river_generation.jpg)

The height map is shaded based upon the horizontal component of the slope. Short strokes are drawn at faces where the slope is above some threshold. Strokes pointing upwards from left to right are drawn if the height map is sloping upward from left to right, and strokes pointing downward from left to right are drawn if the height map is sloping downward from left to right.

![alt tag](http://rlguy.com/map_generation/images/slope_shading.jpg)

## Generating Cities and Borders

City score values are computed before the placement of a city and have a bonus at locations where there is a high flux value and a penalty at locations that are too close to other cities or too close to the edge of the map.

![alt tag](http://rlguy.com/map_generation/images/city_scores.jpg)

Cities are placed at locations where the city score value is at a maximum.

![alt tag](http://rlguy.com/map_generation/images/city_locations.jpg)

For each city, the movement cost is calculated for each tile (Voronoi face). Movement costs are based on horizontal and vertical distance, amount of flux (crossing rivers), and transitioning from land to sea (or sea to land).

![alt tag](http://rlguy.com/map_generation/images/movement_costs.jpg)

The tiles are then divided amongst the cities depending on who has the lowest movement cost for the tile.

![alt tag](http://rlguy.com/map_generation/images/territories_unclean.jpg)

This method tends to create jagged borders and disjointed territories. The territories are cleaned up by smoothing the edges and by instating a rule that a city territory must contain the city and be a contiguous region.

![alt tag](http://rlguy.com/map_generation/images/territories_clean.jpg)

Borders are then generated around the city territories.

![alt tag](http://rlguy.com/map_generation/images/territory_borders.jpg)

Towns can be added to the map by using the same process that is used to generate city locations. Towns are contained within the city territories and are not involved in territory/border generation.

## Generating Label Positions

The label placement system is based on methods described in this paper: [A General Cartographic Labeling Algorithm](http://www.merl.com/publications/docs/TR96-04.pdf). 

There are two types of labels that will need to be generated: marker labels that label city and town markers, and area labels that label the city territories.

The labeling process begins by generating candidate label positions for the marker and area labels and calculating a base score for each label.

Marker label candidates are generated around a city or town marker. The calculated scores depend on orientation about the marker, how many river, border, and contour lines the label overlaps, whether the label overlaps another marker, and whether the marker is contained within the map.

![alt tag](http://rlguy.com/map_generation/images/marker_label_candidates.jpg)

Area label candidates are generated within territory boundaries. The calculated scores are similar to the marker label scores except that the orientation score is based upon how much of the label is contained within the territory that it names.

![alt tag](http://rlguy.com/map_generation/images/area_label_candidates.jpg)

The number of area label candidates is then narrowed down by selecting only the candidates with the best scores.

![alt tag](http://rlguy.com/map_generation/images/area_label_candidates_refined.jpg)